# 🌪️ 數據模擬器使用指南

## 📝 簡介

`simulator.py` 是一個簡易的風力發電機數據模擬器，可以**每秒自動發送**模擬數據到後端 API，用於測試即時監控功能。

---

## ⚡ 快速開始

### 1. 安裝依賴

```bash
pip install requests
```

### 2. 設定 API 位址

編輯 `simulator.py`，選擇你的 API 位址：

```python
# 本地測試
#API_URL = "http://localhost:5000/api/v1/ingest"

# Zeabur 部署（已啟用）
API_URL = "https://cyutfan-backend.zeabur.app/api/v1/ingest"
```

### 3. 運行模擬器

```bash
python simulator.py
```

### 4. 停止模擬器

按 `Ctrl + C` 停止。

---

## 🎯 功能說明

### 自動發送數據
- **間隔時間：** 1 秒（可自訂 `INTERVAL` 變數）
- **設備 ID：** esp32-001（可自訂 `DEVICE_ID` 變數）
- **API Key：** dev-secret-key（需與後端設定一致）

### 模擬數據範圍

| 感測器 | 範圍 | 單位 |
|--------|------|------|
| 電壓 (voltage_v) | 11.5 ~ 13.5 | V |
| 電流 (current_a) | 0.8 ~ 2.0 | A |
| **功率 (power_w)** | **雲端自動計算** | **W** |
| 轉速 (rpm) | 2800 ~ 4200 | RPM |
| 氣壓 (pressure_hpa) | 1010.0 ~ 1020.0 | hPa |
| 溫度 (temp_c) | 20.0 ~ 35.0 | °C |
| 濕度 (humidity_pct) | 40.0 ~ 70.0 | % |
| 風速 (wind_mps) | 2.0 ~ 6.0 | m/s |

### 輸出範例

```
======================================================================
🌪️  風力發電機數據模擬器
======================================================================
📡 API 位址: https://cyutfan-backend.zeabur.app/api/v1/ingest
🔑 API Key: dev-secret-key
📟 設備 ID: esp32-001
⏱️  發送間隔: 1 秒
======================================================================
開始發送數據... (按 Ctrl+C 停止)

✅ [14:23:15] 數據已發送 | 功率: 19.14W | 電壓: 13.2V | 電流: 1.45A | 轉速: 3520 RPM
✅ [14:23:16] 數據已發送 | 功率: 15.87W | 電壓: 12.1V | 電流: 1.31A | 轉速: 3680 RPM
✅ [14:23:17] 數據已發送 | 功率: 22.05W | 電壓: 12.9V | 電流: 1.71A | 轉速: 3450 RPM
📊 已發送 10 筆數據

✅ [14:23:25] 數據已發送 | 功率: 18.20W | 電壓: 13.0V | 電流: 1.40A | 轉速: 3590 RPM
```

---

## 🔧 自訂設定

### 修改發送間隔

```python
INTERVAL = 0.5  # 每 0.5 秒發送一次（更快）
INTERVAL = 5    # 每 5 秒發送一次（更慢）
```

### 修改設備 ID

```python
DEVICE_ID = "esp32-002"  # 模擬第二台設備
```

### 修改 API Key

```python
API_KEY = "your-custom-api-key"  # 使用自訂 API 金鑰
```

### 自訂數據範圍

編輯 `generate_sensor_data()` 函數：

```python
def generate_sensor_data():
    voltage = round(random.uniform(10.0, 15.0), 2)  # 自訂電壓範圍
    current = round(random.uniform(0.5, 3.0), 2)     # 自訂電流範圍
    # ... 其他感測器 ...
```

---

## 📊 即時監控驗證

### 測試步驟

1. **啟動模擬器**
   ```bash
   python simulator.py
   ```

2. **開啟網頁儀表板**
   - 本地：http://localhost:5173
   - Zeabur：https://your-frontend.zeabur.app

3. **驗證即時更新**
   - ⚡ 功率卡片應該**每秒更新**（顯示雲端計算的 P = V × I）
   - 📈 所有 7 個指標卡片應該同步更新
   - 🕒 「最後更新」時間應該持續刷新
   - 📉 歷史圖表應該自動添加新數據點

4. **驗證功率計算**
   - 功率卡片顯示：**19.14 W**
   - 下方公式顯示：**P = V × I = 13.20 × 1.45**
   - 確認計算正確：13.20 × 1.45 = 19.14 ✅

---

## ⚠️ 常見問題

### 1. 連線錯誤

```
❌ 連線錯誤: 無法連接到 https://cyutfan-backend.zeabur.app/api/v1/ingest
```

**解決方法：**
- 確認後端服務正在運行
- 檢查 API URL 是否正確
- 測試後端連通性：
  ```bash
  curl https://cyutfan-backend.zeabur.app/api/v1/devices
  ```

### 2. 請求超時

```
❌ 請求超時
```

**解決方法：**
- 增加 timeout 時間（已設為 10 秒）
- 檢查網路連線
- 確認 Zeabur 服務未休眠

### 3. API Key 錯誤

```
❌ 發送失敗: 401 - {"error":"Invalid or missing API key"}
```

**解決方法：**
- 確認 `API_KEY` 與後端 `.env` 中的 `API_KEY` 一致
- 預設值：`dev-secret-key`

### 4. 顯示「發送失敗: 201」

**這其實是成功！**
- HTTP 201 = Created（成功創建資源）
- 模擬器已修復，現在會正確顯示 ✅

---

## 🚀 進階用法

### 模擬多台設備

創建多個終端，運行不同設備：

**終端 1：**
```python
# simulator.py
DEVICE_ID = "esp32-001"
```
```bash
python simulator.py
```

**終端 2：**
```python
# simulator_002.py（複製一份）
DEVICE_ID = "esp32-002"
```
```bash
python simulator_002.py
```

### 模擬異常數據

測試極端情況：

```python
def generate_sensor_data():
    # 模擬電壓驟降
    voltage = round(random.uniform(8.0, 10.0), 2)

    # 模擬高電流
    current = round(random.uniform(3.0, 5.0), 2)

    # 功率會在雲端自動計算：P = 8.0 × 5.0 = 40W
```

### 模擬斷線

停止模擬器 5 分鐘以上，設備狀態會變為「離線」：

```bash
# 停止模擬器
Ctrl + C

# 等待 5 分鐘

# 網頁應該顯示：🔴 離線
```

---

## 📈 效能測試

### 壓力測試

測試系統能否處理高頻數據：

```python
INTERVAL = 0.1  # 每 0.1 秒發送一次（10 次/秒）
```

**預期結果：**
- 後端應該能處理
- SSE 即時推送正常
- 前端動畫流暢
- 資料庫寫入無延遲

---

## 🔄 功率計算流程

### 舊架構（前端計算）
```
ESP32 → 雲端 → 瀏覽器 → 計算 P = V × I → 顯示
```

### 新架構（雲端計算）✨
```
ESP32 → 雲端（計算 P = V × I）→ 儲存功率 → 瀏覽器 → 直接顯示
         ↓
      資料庫（新增 power_w 欄位）
         ↓
      SSE 推送（包含 power_w）
```

**優勢：**
- ✅ 可在後端查詢功率範圍（例如：找出功率 > 50W 的數據）
- ✅ 歷史數據包含功率值
- ✅ 前端只需顯示，不用重複計算
- ✅ 數據一致性更高

---

## 📝 數據格式

### 發送格式（ESP32/模擬器 → 雲端）

```json
{
  "device_id": "esp32-001",
  "ts": 1704067200000,
  "voltage_v": 13.2,
  "current_a": 1.45,
  "rpm": 3520,
  "pressure_hpa": 1014.5,
  "temp_c": 26.3,
  "humidity_pct": 58.1,
  "wind_mps": 3.8
}
```

**注意：** 不需要發送 `power_w`，雲端會自動計算！

### 回應格式（雲端 → 前端）

```json
{
  "status": "success",
  "id": 42,
  "device_id": "esp32-001"
}
```

### SSE 推送格式（雲端 → 前端）

```json
{
  "device_id": "esp32-001",
  "timestamp": "2024-01-01T12:00:00",
  "voltage_v": 13.2,
  "current_a": 1.45,
  "power_w": 19.14,
  "rpm": 3520,
  "pressure_hpa": 1014.5,
  "temp_c": 26.3,
  "humidity_pct": 58.1,
  "wind_mps": 3.8
}
```

**注意：** 包含 `power_w` 欄位（雲端計算結果）！

---

## ✅ 驗證清單

測試雲端功率計算功能時，確認以下項目：

- [ ] 模擬器成功發送數據（無錯誤訊息）
- [ ] 後端 log 顯示功率計算：`⚡ Calculated power: 19.14W (V=13.2V, I=1.45A)`
- [ ] 功率卡片顯示正確數值
- [ ] 功率公式顯示：`P = V × I = 13.20 × 1.45`
- [ ] 每秒即時更新（最後更新時間持續刷新）
- [ ] SSE 連線穩定（無斷線重連）
- [ ] 歷史圖表包含功率數據點
- [ ] 資料庫包含 `power_w` 欄位（可選）

---

## 🎉 成功標誌

如果看到以下畫面，表示功率雲端計算成功：

```
┌──────────────────────────────┐
│ ⚡ 功率輸出                  │
│                              │
│        19.14 W               │
│                              │
│ P = V × I = 13.20 × 1.45     │
└──────────────────────────────┘
```

**關鍵驗證：**
1. 功率數值來自後端（不是前端計算）
2. 公式顯示正確的電壓和電流
3. 計算結果準確：13.20 × 1.45 = 19.14 ✅

---

**模擬器準備就緒！** 🚀

立即運行 `python simulator.py`，開始測試即時監控功能！
